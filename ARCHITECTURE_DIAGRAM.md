# STM32H750 Bootloader 系统架构图

## 启动流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         系统复位                                 │
│                            ↓                                     │
│                  CPU 从 0x08000000 启动                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Bootloader 初始化                             │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  1. HAL_Init()                                          │    │
│  │  2. SystemClock_Config()  → 480MHz                     │    │
│  │  3. GPIO_Init()           → 初始化引脚                  │    │
│  │  4. UART_Init()           → 调试输出 115200            │    │
│  │  5. QSPI_Init()           → 配置 QSPI 接口             │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                 QSPI Flash (W25Q256) 初始化                      │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  1. QSPI_W25Qxx_Reset()   → 软复位 Flash               │    │
│  │  2. QSPI_W25Qxx_ReadID()  → 读取并验证 ID: 0xEF4019   │    │
│  │  3. 配置 QSPI 参数                                      │    │
│  │     - Clock: 240MHz / 2 = 120MHz                       │    │
│  │     - Mode: 1-4-4 (Quad SPI)                           │    │
│  │     - Flash Size: 32MB (2^25 = 0x2000000)             │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              配置 QSPI 为内存映射模式                            │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  QSPI_W25Qxx_MemoryMappedMode()                        │    │
│  │  ┌──────────────────────────────────────────────┐      │    │
│  │  │  配置参数:                                    │      │    │
│  │  │  - Instruction: 0xEC (Fast Read Quad I/O)   │      │    │
│  │  │  - Address Mode: 4 lines                    │      │    │
│  │  │  - Data Mode: 4 lines                       │      │    │
│  │  │  - Dummy Cycles: 6                          │      │    │
│  │  │  - 映射地址: 0x90000000                     │      │    │
│  │  └──────────────────────────────────────────────┘      │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                 │
│  结果: CPU 可以直接从 0x90000000 读取 Flash 内容               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     准备跳转到应用程序                           │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  1. 读取应用程序信息                                    │    │
│  │     - SP  = *(__IO uint32_t*)0x90000000  (堆栈指针)    │    │
│  │     - PC  = *(__IO uint32_t*)0x90000004  (Reset地址)   │    │
│  │                                                         │    │
│  │  2. 验证堆栈指针                                        │    │
│  │     if ((SP & 0xFFFF0000) == 0x24000000) → 有效       │    │
│  │                                                         │    │
│  │  3. 禁用系统功能                                        │    │
│  │     - SCB_DisableICache()    → 关闭指令缓存           │    │
│  │     - SCB_DisableDCache()    → 关闭数据缓存           │    │
│  │     - SysTick->CTRL = 0      → 关闭系统定时器         │    │
│  │     - __disable_irq()        → 禁用所有中断           │    │
│  │                                                         │    │
│  │  4. 设置堆栈和跳转                                      │    │
│  │     - __set_MSP(SP)          → 设置主堆栈指针         │    │
│  │     - JumpToApplication()    → 跳转到 PC 地址         │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   应用程序开始执行                               │
│                   (在外部 Flash 0x90000000)                     │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  1. Reset_Handler 执行                                  │    │
│  │     - 初始化 .data 段 (RAM)                            │    │
│  │     - 清零 .bss 段 (RAM)                               │    │
│  │     - 调用 SystemInit()                                │    │
│  │                                                         │    │
│  │  2. SystemInit()                                       │    │
│  │     - SCB->VTOR = 0x90000000  → 重定位向量表          │    │
│  │     - 配置 FPU                                         │    │
│  │     - 其他系统初始化                                    │    │
│  │                                                         │    │
│  │  3. main() 开始执行                                    │    │
│  │     - HAL_Init()                                       │    │
│  │     - SystemClock_Config()                             │    │
│  │     - 外设初始化                                        │    │
│  │     - FreeRTOS 启动                                    │    │
│  └────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  应用程序正常运行                                │
│                  (FreeRTOS 调度任务)                             │
└─────────────────────────────────────────────────────────────────┘
```

## 内存映射架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        地址空间映射                              │
└─────────────────────────────────────────────────────────────────┘

0x00000000  ┌─────────────────────────────────────────┐
            │  ITCMRAM (64KB)                         │  指令 TCM
            │  - 快速指令访问                          │
0x0000FFFF  └─────────────────────────────────────────┘

0x08000000  ┌─────────────────────────────────────────┐
            │  内部 Flash (128KB)                     │
            ├─────────────────────────────────────────┤
            │                                         │
            │  Bootloader (0 - 64KB)                 │  ← 从这里启动
            │  ├─ .isr_vector                        │
            │  ├─ .text (代码段)                     │
            │  ├─ .rodata (只读数据)                 │
            │  └─ 初始化数据 (LMA)                   │
            │                                         │
0x0800FFFF  ├─────────────────────────────────────────┤
            │                                         │
            │  保留区域 (64KB)                        │
            │  - 可用于固件更新                       │
            │  - 或配置数据存储                       │
            │                                         │
0x0801FFFF  └─────────────────────────────────────────┘

0x20000000  ┌─────────────────────────────────────────┐
            │  DTCMRAM (128KB)                        │  数据 TCM
            │  - 快速数据访问                          │
            │  - 关键变量和堆栈                        │
0x2001FFFF  └─────────────────────────────────────────┘

0x24000000  ┌─────────────────────────────────────────┐
            │  AXI SRAM (RAM_D1) (512KB)              │  主内存
            │  ├─ .data (初始化数据, VMA)             │
            │  ├─ .bss (未初始化数据)                 │
            │  ├─ .heap (堆)                          │
            │  └─ .stack (栈)                         │  ← _estack
            │                                         │
            │  FreeRTOS 任务栈:                       │
            │  - DefaultTask (128 words)              │
            │  - 其他任务...                          │
0x2407FFFF  └─────────────────────────────────────────┘

0x30000000  ┌─────────────────────────────────────────┐
            │  AHB SRAM (RAM_D2) (288KB)              │  DMA/外设用
            │  - DMA 缓冲区                           │
            │  - 外设数据缓冲                          │
0x30047FFF  └─────────────────────────────────────────┘

0x38000000  ┌─────────────────────────────────────────┐
            │  AHB SRAM (RAM_D3) (64KB)               │  备份域
            │  - 备份 SRAM                            │
0x3800FFFF  └─────────────────────────────────────────┘

0x90000000  ┌─────────────────────────────────────────┐
            │  外部 QSPI Flash (32MB)                  │
            │  W25Q256 内存映射模式                    │
            ├─────────────────────────────────────────┤
            │                                         │
            │  应用程序 (最大 32MB)                   │  ← 应用从这里运行
            │  ├─ .isr_vector (向量表)               │
            │  ├─ .text (代码段)                     │
            │  ├─ .rodata (只读数据)                 │
            │  ├─ .data (初始化数据, LMA)            │
            │  └─ 其他代码和资源                      │
            │                                         │
            │  可用空间: ~32MB                        │
            │  - 主应用程序                           │
            │  - 图形资源 (GUI)                       │
            │  - 文件系统                             │
            │  - 固件更新区                           │
            │                                         │
0x91FFFFFF  └─────────────────────────────────────────┘

外设地址    ┌─────────────────────────────────────────┐
0x40000000  │  APB1/APB2/APB3/APB4 外设               │
...         │  AHB1/AHB2/AHB3/AHB4 外设               │
0x5FFFFFFF  └─────────────────────────────────────────┘
```

## QSPI 接口连接图

```
┌─────────────────────────────────────────┐
│         STM32H750XBH6                   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │        QSPI 控制器               │   │         ┌──────────────────────┐
│  │  ┌──────────────────────────┐   │   │         │    W25Q256JV         │
│  │  │  Memory Mapped           │   │   │         │   (32MB QSPI Flash)  │
│  │  │  Address: 0x90000000     │   │   │         │                      │
│  │  └──────────────────────────┘   │   │         │  VCC  ────────  3.3V │
│  │                                  │   │         │  GND  ────────  GND  │
│  │  QSPI_CLK  ──────────────────────┼───┼─────────│  CLK                │
│  │  QSPI_BK1_NCS ────────────────────┼───┼─────────│  CS#                │
│  │  QSPI_BK1_IO0 ────────────────────┼───┼─────────│  IO0 (MOSI)         │
│  │  QSPI_BK1_IO1 ────────────────────┼───┼─────────│  IO1 (MISO)         │
│  │  QSPI_BK1_IO2 ────────────────────┼───┼─────────│  IO2 (WP#)          │
│  │  QSPI_BK1_IO3 ────────────────────┼───┼─────────│  IO3 (HOLD#)        │
│  └──────────────────────────────────┘   │         │                      │
│                                         │         └──────────────────────┘
│  典型 GPIO 配置:                        │
│  - PF10: QSPI_CLK                       │         通信模式:
│  - PG6:  QSPI_BK1_NCS                   │         - 1-1-1: 标准 SPI
│  - PF8:  QSPI_BK1_IO0                   │         - 1-1-4: Quad Output
│  - PF9:  QSPI_BK1_IO1                   │         - 1-4-4: Quad I/O (最快)
│  - PF7:  QSPI_BK1_IO2                   │
│  - PF6:  QSPI_BK1_IO3                   │         时钟: 最高 133MHz
│                                         │
└─────────────────────────────────────────┘
```

## 数据流向图

```
┌────────────────────────────────────────────────────────────────────┐
│                         编译和烧录流程                              │
└────────────────────────────────────────────────────────────────────┘

源代码                   编译                      二进制文件
┌─────────┐          ┌──────────┐              ┌──────────────┐
│ main.c  │          │          │              │              │
│ (+ 宏   │──────────│  GCC     │──────────────│ bootloader   │
│  USE_   │          │  ARM     │              │ .elf .hex    │
│  BOOT   │          │          │              │              │
│ LOADER) │          │          │              │ 大小: <64KB  │
└─────────┘          └──────────┘              └──────────────┘
                           │                           │
                           │ 链接脚本                   │
                           │ BOOTLOADER.ld             │
                           ↓                           ↓
                     ┌──────────┐              ┌──────────────┐
                     │ 0x080000 │              │ ST-Link /    │
                     │ 内部Flash│←─────────────│ J-Link       │
                     └──────────┘     烧录      │ Programmer   │
                                                └──────────────┘

源代码                   编译                      二进制文件
┌─────────┐          ┌──────────┐              ┌──────────────┐
│ main.c  │          │          │              │              │
│ (无宏   │──────────│  GCC     │──────────────│ application  │
│  定义)  │          │  ARM     │              │ .elf .hex    │
│         │          │          │              │              │
│ +RTOS   │          │          │              │ 大小: <32MB  │
└─────────┘          └──────────┘              └──────────────┘
                           │                           │
                           │ 链接脚本                   │
                           │ EXTFLASH.ld               │
                           ↓                           ↓
                     ┌──────────┐              ┌──────────────┐
                     │0x9000000 │              │ ST-Link +    │
                     │ 外部Flash│←─────────────│ Ext Loader   │
                     └──────────┘     烧录      │ (W25Q256)    │
                                                └──────────────┘
```

## 运行时交互图

```
┌────────────────────────────────────────────────────────────────────┐
│                      Bootloader 运行时                              │
└────────────────────────────────────────────────────────────────────┘

时间 →

0ms    │ 芯片复位
       ↓
       ┌─────────────────┐
10ms   │ Bootloader Init │ → UART: "Bootloader Starting..."
       └─────────────────┘
       ↓
       ┌─────────────────┐
50ms   │ QSPI Init       │ → UART: "QSPI Flash ID: 0xEF4019"
       └─────────────────┘
       ↓
       ┌─────────────────┐
70ms   │ Memory Mapped   │ → UART: "Memory mapped mode enabled"
       └─────────────────┘
       ↓
       ┌─────────────────┐
100ms  │ Jump Prepare    │ → UART: "Jumping to 0x9000XXXX"
       └─────────────────┘
       ↓
       ┌─────────────────┐
101ms  │ Jump!           │
       └─────────────────┘
       ↓
┌────────────────────────────────────────────────────────────────────┐
│                      应用程序运行时                                 │
└────────────────────────────────────────────────────────────────────┘
       ↓
       ┌─────────────────┐
102ms  │ App Reset       │ → 向量表重定位到 0x90000000
       └─────────────────┘
       ↓
       ┌─────────────────┐
150ms  │ App Init        │ → UART: "Application Started"
       └─────────────────┘
       ↓
       ┌─────────────────┐
200ms  │ RTOS Start      │ → UART: "FreeRTOS scheduler started"
       └─────────────────┘
       ↓
       ┌─────────────────┐
∞      │ Tasks Running   │ → 正常运行
       └─────────────────┘
```

## 错误处理流程

```
┌────────────────────────────────────────────────────────────────────┐
│                      Bootloader 错误处理                            │
└────────────────────────────────────────────────────────────────────┘

QSPI_W25Qxx_Init()
       │
       ├─ 成功 ────→ 继续
       │
       └─ 失败 ────→ ┌──────────────────────────┐
                      │ UART: "ERROR: QSPI Init" │
                      │ LED 闪烁 (错误指示)      │
                      │ 进入死循环               │
                      └──────────────────────────┘

QSPI_W25Qxx_ReadID()
       │
       ├─ 0xEF4019 ─→ 继续
       │
       └─ 其他 ─────→ ┌──────────────────────────┐
                      │ UART: "WARNING: ID"      │
                      │ 尝试继续 (可能工作)      │
                      └──────────────────────────┘

QSPI_W25Qxx_MemoryMappedMode()
       │
       ├─ 成功 ────→ 继续
       │
       └─ 失败 ────→ ┌──────────────────────────┐
                      │ UART: "ERROR: MemMap"    │
                      │ 无法跳转                 │
                      │ 进入死循环               │
                      └──────────────────────────┘

检查堆栈指针
       │
       ├─ 有效 ────→ 跳转
       │
       └─ 无效 ────→ ┌──────────────────────────┐
                      │ UART: "WARNING: Invalid" │
                      │ UART: "SP = 0xXXXXXXXX"  │
                      │ 尝试跳转 (可能失败)      │
                      └──────────────────────────┘
```

---

**提示**: 这些架构图展示了系统的完整工作流程，可以帮助理解 Bootloader 的实现细节。
